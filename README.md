# Publication Data Analysis Codebase

This README provides an overview of the R scripts used for analyzing publication data, including data preparation, descriptive statistics, visualization, and modeling. The codebase is structured to process and analyze publication data, focusing on metrics such as publication rates, authorship positions, and demographic factors like gender and ethnicity.

## Code Structure

The codebase consists of four main R scripts, each serving a distinct purpose in the data analysis pipeline:

1. **prep_anonymous_dataset.R**: Prepares and anonymizes the raw publication dataset.
2. **descriptives.R**: Generates descriptive statistics for the publication data.
3. **plots.R**: Creates visualizations to explore publication patterns by gender, ethnicity, and job category.
4. **models.R**: Fits statistical models to analyze publication rates and authorship positions.

Below is a detailed description of each script, including its purpose, inputs, outputs, and key functionalities.

---

## 1. prep_anonymous_dataset.R

### Purpose
This script loads the raw publication dataset, processes it by adding derived variables (e.g., time periods, pandemic indicator), anonymizes sensitive fields (e.g., usernames, publication titles), and prepares a network dataset for further analysis.

### Inputs
- **clean_data_final.csv**: Raw publication dataset containing publication records with fields like `Title`, `Username`, `date`, `year`, `gender`, `race`, `job_cat`, `author_position`, and `N_authors`.
- **centrality_measures_year.csv**: Network dataset with centrality measures (e.g., degree) by username and year.

### Outputs
- **clean_data_final_anon.csv**: Anonymized publication dataset with `Title` replaced by `Pub1`, `Pub2`, etc., and `Username` replaced by `ID1`, `ID2`, etc.
- **centrality_measures_year_anon.csv**: Anonymized network dataset with usernames replaced by anonymized IDs.

### Key Functionalities
- Loads and processes the raw publication data using `dplyr`.
- Creates time period categories (e.g., "2014-2015", "2016-2017") and a pandemic indicator ("pandemic" or "not pandemic") based on the `date` and `year` fields.
- Defines multiple job category variables (`job_cat_old`, `job_cat_simplified`, `job_cat_simplified2`, `job_cat_simplified3`, `job_cat_simplified4`, `job_cat_broad`) using `factor` and `fct_collapse` for different levels of aggregation.
- Anonymizes `Title` and `Username` fields to protect identifiable information.
- Merges and anonymizes the network dataset by mapping usernames to anonymized IDs.

---

## 2. descriptives.R

### Purpose
This script computes descriptive statistics for the anonymized publication dataset, summarizing publication counts, authorship positions, and demographic distributions (gender, race, job category).

### Inputs
- **clean_data_final_anon.csv**: Anonymized publication dataset generated by `prep_anonymous_dataset.R`.

### Outputs
- Console output of various summary tables and statistics, including:
  - Number of records, unique publications, and unique staff.
  - Distributions of staff by gender, race, race group, and job category.
  - Publication counts by gender, year, and job category.
  - Median and quartile statistics for publications and co-authors by gender and job category.

### Key Functionalities
- Loads required R packages (`tidyverse`, `dplyr`, `ggplot2`, `ggpubr`, `RColorBrewer`).
- Defines a custom `ggplot2` theme (`theme1`) for consistent visualization styling.
- Aggregates data by author (`anon_id`) to compute metrics like total publications (`N_publications`), median number of authors (`N_authors_median`), and median author position (`individual_position_median`).
- Generates summary tables for:
  - Job categories (`job_cat_simplified`, `job_cat_old`).
  - Gender and race distributions.
  - Publications by gender and year.
  - Median and quartile statistics for publications and co-authors.
- Computes statistics for author positions (first, middle, last) by gender and job category.

---

## 3. plots.R

### Purpose
This script generates visualizations to explore publication patterns by gender, ethnicity, and job category, focusing on the number of people and annual publication rates.

### Inputs
- **clean_data_final_anon.csv**: Anonymized publication dataset.

### Outputs
- PNG files saved to `/Users/paulachristen/SPH Pub Bias/Figures/`:
  - `number_of_people_by_job_rg.png`: Bar plot of the number of people by job category, gender, and ethnicity.
  - `pr_by_job_gender.png`: Boxplots of annual publication rates by job category and gender.
  - `authorposition_annual_gender.png`: Boxplots of annual publication rates by author position and gender.
  - `pr_by_job_rg.png`: Boxplots of annual publication rates by job category and ethnicity.
  - `authorposition_annual_race.png`: Boxplots of annual publication rates by author position and ethnicity.
  - `authorposition_annual_combined.png`: Combined plot stacking gender and ethnicity by author position.
  - `pr_by_job_combined.png`: Combined plot stacking gender and ethnicity by job category.

### Key Functionalities
- Loads required R packages (`tidyverse`, `dplyr`, `ggtext`, `ggplot2`, `ggpubr`, `RColorBrewer`, `grid`).
- Applies the same custom `ggplot2` theme (`theme1`) as in `descriptives.R`.
- Transforms `race_group` ("white" to "Non-minoritized", others to "Minoritized") and `gender` ("male" to "Man", "female" to "Woman") for plotting.
- Combines first and last author positions into a single "first/last" category.
- Creates a `dat_annual` dataset aggregating publication counts by `anon_id`, `year`, `gender`, `race_group`, `job_cat_simplified3`, and `author_position`.
- Adds zero-publication rows for missing years to ensure complete time series data.
- Generates boxplots and bar plots with faceting by job category or author position, including summary statistics (median, quartiles, sample size) as text annotations.
- Uses `ggarrange` and `annotate_figure` to create combined plots with shared legends and aligned axes.

---

## 4. models.R

### Purpose
This script fits negative binomial generalized linear mixed models (GLMMs) to analyze annual publication rates, authorship positions, and network centrality, accounting for individual-level random effects.

### Inputs
- **clean_data_final_anon.csv**: Anonymized publication dataset.
- **centrality_measures_year_anon.csv**: Anonymized network dataset with centrality measures.

### Outputs
- HTML files saved to `./regression_results/` containing regression tables for each model combination.
- PNG files saved to `./regression_plots/` containing forest plots of model coefficients.

### Key Functionalities
- Loads required R packages (`glmmTMB`, `tidyverse`, `lubridate`, `MASS`, `broom`, `dplyr`, `sjPlot`).
- Creates a `dat_annual` dataset aggregating publication counts by `anon_id`, `year`, `time`, `pandemic`, `gender`, `race_group`, `job_cat_broad`, `job_cat_simplified3`, and `author_position`.
- Computes additional outcomes: `apos_firstlast` (first or last author publications) and `apos_middle` (middle author publications).
- Merges with network data to include degree centrality (`deg`).
- Adds zero-publication rows for missing years.
- Centers the `year` variable at 2019 for regression (`year_reg`).
- Defines a `model_function` to fit four GLMMs (`m_1` to `m_4`) with different interaction terms:
  - `m_1`: Main effects of `time`, `gender`, `race_group`, and `job_cat_simplified3`.
  - `m_2`: Adds `gender*race_group` interaction.
  - `m_3`: Adds `time*gender` interaction.
  - `m_4`: Adds `job_cat_simplified3*gender` interaction.
- Fits models for four outcomes: `N_pub` (total publications), `apos_firstlast`, `apos_middle`, and `deg` (degree centrality).
- Uses `glmmTMB` with a negative binomial family (`nbinom2`) and a random intercept for `anon_id`.
- Saves regression tables using `sjPlot::tab_model` and forest plots using `sjPlot::plot_models`.
- Runs models for specified combinations of reference groups (currently fixed to `non-white`, `female`, `2014-2015`, `Student / Research Assistant`).

---

## Dependencies
All scripts rely on the following R packages:
- `tidyverse` (data manipulation and visualization)
- `dplyr` (data manipulation)
- `ggplot2` (plotting)
- `ggpubr` (plot arrangement)
- `RColorBrewer` (color palettes)
- `ggtext` (text annotations in plots, used in `plots.R`)
- `grid` (plot annotations, used in `plots.R`)
- `glmmTMB` (GLMM fitting, used in `models.R`)
- `lubridate` (date handling, used in `models.R` and `prep_anonymous_dataset.R`)
- `MASS` (statistical functions, used in `models.R`)
- `broom` (model tidying, used in `models.R`)
- `sjPlot` (model visualization, used in `models.R`)

Scripts check for and install these packages if not already installed.

---

## Data Assumptions
- The input datasets (`clean_data_final.csv`, `centrality_measures_year.csv`) are assumed to be in the `data_cleaning/manuscript_data/` directory. These datasets are not publicly available.
- The publication dataset includes fields like `Title`, `Username`, `date`, `year`, `gender`, `race`, `race_group`, `job_cat`, `author_position`, and `N_authors`.
- The network dataset includes `username`, `year`, and `deg` (degree centrality).
- Missing years for individuals are filled with zero publications in `plots.R` and `models.R` to ensure complete time series.

---

## Usage Notes
1. **File Paths**: Update file paths in `plots.R` (e.g., `/Users/paulachristen/SPH Pub Bias/Figures/`) to match your local directory structure.
2. **Data Availability**: The raw datasets (`clean_data_final.csv`, `centrality_measures_year.csv`) are not publicly available due to identifiable information. Ensure you have access to these files or equivalent anonymized versions.
3. **Customization**: Modify reference groups in `models.R` or job category levels in `prep_anonymous_dataset.R` to explore different analytical perspectives.
4. **Output Directories**: The `regression_results` and `regression_plots` directories are created automatically by `models.R` if they do not exist.

---

## Running the Code
1. Start with `prep_anonymous_dataset.R` to generate anonymized datasets.
2. Run `descriptives.R` to compute summary statistics and inspect the data.
3. Execute `plots.R` to generate visualizations.
4. Run `models.R` to fit statistical models and produce regression tables and plots.

Ensure all required packages are installed and input datasets are accessible before running the scripts.

---
